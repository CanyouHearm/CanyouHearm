
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
        <title>Hexo</title>
        <meta name="author" content="John Doe">
        <meta name="description" content="">
        <meta name="keywords" content="">
        <link rel="icon" href="">
        <script src="https://cdn.staticfile.org/instant.page/5.1.0/instantpage.min.js" type="module"></script>
        <script src="https://cdn.staticfile.org/font-awesome/6.1.1/js/all.min.js"></script>
        
        <link rel="stylesheet" href="/css/fonts.min.css">
        <link rel="stylesheet" href="/css/particlex.css">
        
        <script src="https://cdn.staticfile.org/vue/3.2.33/vue.global.prod.min.js"></script>
    <meta name="generator" content="Hexo 6.2.0"></head>
    <body>
        <div id="loading" style="height:100vh;width:100vw;position:fixed;display:flex;z-index:200;justify-content:space-between;background:#fff;transition:opacity 0.3s ease-out"><div style="position:fixed;height:100vh;width:100vw;display:flex;justify-content:center;align-items:center"><div id="loadcontent" style="width:50vmin;height:50vmin;padding:50px;border-radius:50%;display:flex;justify-content:center;align-items:center;border:solid 10px #a3ddfb;text-align:center"><div><h2>LOADING...</h2><p style="word-break:keep-all">加载过慢请开启缓存(浏览器默认开启)</p><div><img alt="loading" src="/loading.gif"></div></div></div></div></div>
        <div id="layout">
            <i data-fa-symbol="calendar-solid" class="fa-solid fa-calendar fa-fw"></i>
            <i data-fa-symbol="bookmark-solid" class="fa-solid fa-bookmark fa-fw"></i>
            <i data-fa-symbol="tags-solid" class="fa-solid fa-tags fa-fw"></i>
            <transition name="into">
                <div v-show="show_page" style="display: -not-none">
                    <div id="menu_show">
                         
<nav id="menu">
    <div class="desktop-menu">
        <a href="/">
            <span class="title">Hexo</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;about</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;tags</span>
        </a>
        
    </div>
    <div :class="'phone-menu ' + menu_show" id="phone-menu">
        <div class="curtain" @click="menu_show = !menu_show" v-show="menu_show"></div>
        <div :class="'title'" @click="menu_show = !menu_show">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;Hexo</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="menu_show">
            
            <a href="">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">home</div>
                </div>
            </a>
            
            <a href="about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">about</div>
                </div>
            </a>
            
            <a href="archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">archives</div>
                </div>
            </a>
            
            <a href="categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">categories</div>
                </div>
            </a>
            
            <a href="tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">tags</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>
                    </div>
                    <div id="main">
                        
<div class="article">
    <div>
        <h1> </h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <svg class="fa-icon"><use xlink:href="#calendar-solid"></use></svg>
            </span>
            2022/8/24
        </span>
        
        
    </div>
    <div class="content" v-pre>
        <h1 id="nodejs原型链污染"><a href="#nodejs原型链污染" class="headerlink" title="nodejs原型链污染"></a>nodejs原型链污染</h1><h2 id="NodeJS基础"><a href="#NodeJS基础" class="headerlink" title="NodeJS基础"></a>NodeJS基础</h2><p>它是由C++开发的，它只是一个JavaScript语言解释器。<br>REPL环境运行JavaScript的代码</p>
<p>在浏览器的控制台或者node的运行环境都属于REPL运行环境，均可以运行JS代码。<br>在NodeJS中分为三个模块，分别是：核心模块、自定义模块、第三方模块。<br>这里提一点，JS代码在编程时，如果需要使用某个模块的功能，那么就需要提前将其导入，与Python类似，只不过在Python中使用import关键字，而JS中使用require关键字。</p>
<p>文档：<a target="_blank" rel="noopener" href="http://nodejs.cn/api/fs.html">http://nodejs.cn/api/fs.html</a></p>
<p>基本读文件操作：</p>
<pre><code>var fs = require(&#39;fs&#39;);//导入fs模块
fs.readFile(&#39;./haha.txt&#39;,&#39;utf8&#39;,function(err,data)&#123;
    console.log(err);
    console.log(&#39;---分界线----&#39;);
    console.log(data);
&#125;);
console.log(&quot;wuhu&quot;);
</code></pre>
<h3 id="同步与异步"><a href="#同步与异步" class="headerlink" title="同步与异步"></a>同步与异步</h3><p>同步：按顺序执行</p>
<p>异步：同时开始执行</p>
<p>异步案例：</p>
<pre><code>var fs = require(&#39;fs&#39;);//导入fs模块
fs.readFile(&#39;./haha.txt&#39;,&#39;utf8&#39;,function(err,data)&#123;
    console.log(err);
    console.log(&#39;---分界线----&#39;);
    console.log(data);
&#125;);
console.log(&quot;wuhu&quot;);
</code></pre>
<p>输出顺序不确定</p>
<h3 id="全局变量："><a href="#全局变量：" class="headerlink" title="全局变量："></a>全局变量：</h3><ol>
<li>__dirname：当前模块的目录名。</li>
<li>__filename：当前模块的文件名。 这是当前的模块文件的绝对路径（符号链接会被解析）。</li>
<li>exports变量是默认赋值给<code>module.exports</code>，它可以被赋予新值，它会暂时不会绑定到module.exports。</li>
<li>module：在每个模块中， <code>module</code> 的自由变量是对表示当前模块的对象的引用。 为方便起见，还可以通过全局模块的 <code>exports</code> 访问 <code>module.exports</code>。 module 实际上不是全局的，而是每个模块本地的</li>
<li>require模块就不多说了，用于引入模块、 JSON、或本地文件。 可以从 node_modules 引入模块。</li>
</ol>
<h3 id="简单的HTTP服务"><a href="#简单的HTTP服务" class="headerlink" title="简单的HTTP服务"></a>简单的HTTP服务</h3><pre><code> //引入http核心模块
var http = require(&#39;http&#39;);
//创建一个服务
var server = http.createServer();
//绑定连接
server.on(&#39;request&#39;,function(res,rs)&#123;
    console.log(res.method);//打印请求的方法
    rs.write(&#39;hello,world!&#39;);//返回数据
    rs.end();//断开连接
&#125;)
//启动监听
server.listen(4444,function()&#123;
    console.log(&#39;请访问127.0.0.1:4444&#39;);
</code></pre>
<h3 id="child-process-创建子进程"><a href="#child-process-创建子进程" class="headerlink" title="child_process(创建子进程)"></a>child_process(创建子进程)</h3><p>child_process提供了几种创建子进程的方式</p>
<p>异步方式：spawn、exec、execFile、fork<br>同步方式：spawnSync、execSync、execFileSync</p>
<p>在异步创建进程时，spawn是基础，其他的fork、exec、execFile都是基于spawn来生成的。<br>同步创建进程可以使用<code>child_process.spawnSync()</code>、<code>child_process.execSync()</code> 和 <code>child_process.execFileSync()</code> ，同步的方法会阻塞 Node.js 事件循环、暂停任何其他代码的执行，直到子进程退出。</p>
<h3 id="JavaScript原型链"><a href="#JavaScript原型链" class="headerlink" title="JavaScript原型链"></a>JavaScript原型链</h3><p>JavaScript没有父类和子类这个概念，也没有类和实例的区分，而JavaScript中的继承关系则是靠一种很奇怪的“原型链”模式来实现继承。</p>
<h4 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h4><pre><code>var a = &#123;
    &quot;name&quot;: &quot;m0re&quot;,
    &quot;blog&quot;: &quot;https://m0re.top&quot;
&#125;
a.name;
a.blog;
console.log(a);
</code></pre>
<p>访问属性：</p>
<pre><code>//例如
a.name;
a[&quot;name&quot;];
</code></pre>
<h4 id="原型的定义和继承"><a href="#原型的定义和继承" class="headerlink" title="原型的定义和继承"></a>原型的定义和继承</h4><p>任何对象都有一个原型对象，这个原型对象由对象的内置属性proto指向它的构造函数的prototype指向的对象，即任何对象都是由一个构造函数创建的</p>
<p>即对于如下代码</p>
<pre><code>function Foo() &#123;
    this.bar = 1
&#125;

Foo.prototype.show = function show() &#123;
    console.log(this.bar)
&#125;

let foo = new Foo()
foo.show()
</code></pre>
<p>有<code>foo.__proto__ == Foo.prototype</code></p>
<p>关系如下图所示</p>
<p><img src="/%E5%8D%81%E4%B8%80%C2%B7%EF%BC%8CNodejs%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93.assets/3.png" alt="3.png"></p>
<p>总结一下：</p>
<ol>
<li><code>prototype</code>是一个类的属性，所有类对象在实例化的时候将会拥有<code>prototype</code>中的属性和方法</li>
<li>一个对象的<code>__proto__</code>属性，指向这个对象所在的类的<code>prototype</code>属性</li>
</ol>
<p>继承eg：</p>
<pre><code>function Father() &#123;
    this.first_name = &#39;Donald&#39;
    this.last_name = &#39;Trump&#39;
&#125;

function Son() &#123;
    this.first_name = &#39;Melania&#39;
&#125;

Son.prototype = new Father()

let son = new Son()
console.log(`Name: $&#123;son.first_name&#125; $&#123;son.last_name&#125;`)
</code></pre>
<p>输出结果为：Name: Melania Trump</p>
<p>总结一下，对于对象son，在调用<code>son.last_name</code>的时候，实际上JavaScript引擎会进行如下操作：</p>
<ol>
<li>在对象son中寻找last_name</li>
<li>如果找不到，则在<code>son.__proto__</code>中寻找last_name</li>
<li>如果仍然找不到，则继续在<code>son.__proto__.__proto__</code>中寻找last_name</li>
<li>依次寻找，直到找到<code>null</code>结束。比如，<code>Object.prototype</code>的<code>__proto__</code>就是<code>null</code></li>
</ol>
<h2 id="漏洞发现"><a href="#漏洞发现" class="headerlink" title="漏洞发现"></a>漏洞发现</h2><p>eg;</p>
<pre><code>// foo是一个简单的JavaScript对象
let foo = &#123;bar: 1&#125;

// foo.bar 此时为1
console.log(foo.bar)

// 修改foo的原型（即Object）
foo.__proto__.bar = 2

// 由于查找顺序的原因，foo.bar仍然是1
console.log(foo.bar)

// 此时再用Object创建一个空的zoo对象
let zoo = &#123;&#125;

// 查看zoo.bar
console.log(zoo.bar)
</code></pre>
<p>最后，虽然zoo是一个<strong>空</strong>对象<code>&#123;&#125;</code>，但<code>zoo.bar</code>的结果居然是2</p>
<p>这是因为修改了foo的原型（即Object），而我们又用Object类创建了zoo，那么zoo也具有了bar属性</p>
<p>在实际应用中，哪些情况下可能存在原型链能被攻击者修改的情况呢？</p>
<p>我们思考一下，哪些情况下我们可以设置<code>__proto__</code>的值呢？其实找找能够控制数组（对象）的“键名”的操作即可：</p>
<ul>
<li>对象merge</li>
<li>对象clone（其实内核就是将待操作的对象merge到一个空对象中）</li>
</ul>
<p>即如果可以：</p>
<ul>
<li>字符串可以被解析为方法或对象。例如：Json.parse 进行解析、shvl 库使用点对属性操作。</li>
<li>对象的键和值都可控。target[key] &#x3D; value，其中 key 和 value 均可控制。</li>
</ul>
<p>基本确认存在漏洞</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>以对象merge为例</p>
<p>一个简单的merge函数</p>
<pre><code>function merge(target, source) &#123;
    for (let key in source) &#123;
        if (key in source &amp;&amp; key in target) &#123;
            merge(target[key], source[key])
        &#125; else &#123;
            target[key] = source[key]
        &#125;
    &#125;
&#125;
</code></pre>
<p>在合并的过程中，存在赋值的操作<code>target[key] = source[key]</code>，那么，这个key如果是<code>__proto__</code>，是不是就可以原型链污染呢？</p>
<p>测试1：</p>
<pre><code>let o1 = &#123;&#125;
let o2 = &#123;a: 1, &quot;__proto__&quot;: &#123;b: 2&#125;&#125;
merge(o1, o2)
console.log(o1.a, o1.b)

o3 = &#123;&#125;
console.log(o3.b)
</code></pre>
<p>o结果输出3并没有b属性，即o2没有污染原型链。这是因为o2在创建时，将<code>__proto__</code>当作要指定的原型链而没当作键名</p>
<p>测试2：</p>
<pre><code>let o1 = &#123;&#125;
let o2 = JSON.parse(&#39;&#123;&quot;a&quot;: 1, &quot;__proto__&quot;: &#123;&quot;b&quot;: 2&#125;&#125;&#39;)
merge(o1, o2)
console.log(o1.a, o1.b)

o3 = &#123;&#125;
console.log(o3.b)
</code></pre>
<p>可见，新建的o3对象，也存在b属性，说明Object已经被污染</p>
<p>这是因为，JSON解析的情况下，<code>__proto__</code>会被认为是一个真正的“键名”，而不代表“原型”，所以在遍历o2的时候会存在这个键。</p>
<p>一些常见的污染方法：</p>
<ul>
<li><code>function.__proto__.polluted</code>。</li>
<li><code>function.prototype.polluted</code>。</li>
<li><code>obj.__proto__.pollluted</code>。</li>
<li><code>obj.constructor.polluted</code>。</li>
</ul>
<p>从污染到rce：创建exec的子进程</p>
<h2 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h2><p>如果系统中有键值的操作，并且键和值来自外部输入。可以考虑进行过滤：</p>
<ul>
<li>禁止操作 <code>constructor</code></li>
<li>禁止操作 <code>prototype</code></li>
<li>禁止操作 <code>__proto__</code></li>
</ul>
<h2 id="绕过"><a href="#绕过" class="headerlink" title="绕过"></a>绕过</h2><p>是否过滤完全？<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/355840263">https://zhuanlan.zhihu.com/p/355840263</a></p>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html?page=2#reply-list">https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html?page=2#reply-list</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/236182">https://www.anquanke.com/post/id/236182</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.codesec.work/f0ee9a055ee1/">https://blog.codesec.work/f0ee9a055ee1/</a></p>

    </div>
    
</div>
                         
<footer id="footer">
    <div class="footer-wrap">
        <div>
            © 20xx - 2022 Hexo
            <span class="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            @John Doe
        </div>
        <div></div>
        <div>Based on the <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo Engine</a> & <a
                target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a></div>
        
    </div>
</footer>
                    </div>
                </div>
            </transition>
            <div id="img_show">
                <img id="img_content" alt="img_show">
            </div>
        </div>
        <script src="https://cdn.staticfile.org/highlight.js/11.5.1/highlight.min.js"></script>
        <script src="/js/particlex.js"></script>
        <script src="/js/showimg.js"></script>
        

    </body>
</html>